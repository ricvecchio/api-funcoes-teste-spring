name: CI/CD - Microservices Infra

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: ğŸ§± Build dos serviÃ§os
        run: |
          cd conta-service && mvn clean package -DskipTests -q
          cd ../kafka-service && mvn clean package -DskipTests -q

      - name: ğŸ§© Instalar dependÃªncias auxiliares
        run: sudo apt-get update && sudo apt-get install -y curl netcat-openbsd

      - name: ğŸ³ Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“¦ Build das imagens Docker
        run: |
          docker build -t conta-service:latest -f conta-service/Dockerfile conta-service
          docker build -t kafka-service:latest -f kafka-service/Dockerfile kafka-service

      - name: ğŸš€ Subir ambiente completo com Docker Compose
        run: |
          docker compose -f infra/docker-compose.yml --env-file infra/.env up -d --build

      - name: ğŸ•“ Aguardar serviÃ§os ficarem saudÃ¡veis
        run: |
          echo "Aguardando containers ficarem saudÃ¡veis..."
          timeout 600 bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} zookeeper)" == "healthy" ]; do echo "â³ Aguardando Zookeeper..."; sleep 10; done'
          timeout 600 bash -c 'until [ "$(docker inspect -f {{.State.Health.Status}} kafka-broker)" == "healthy" ]; do echo "â³ Aguardando Kafka..."; sleep 10; done'
          docker compose -f infra/docker-compose.yml ps

      - name: ğŸ” Testar endpoints dos serviÃ§os
        run: |
          echo "âœ… Verificando conta-service"
          curl -f http://localhost:8081/actuator/health
          echo "âœ… Verificando kafka-service"
          curl -f http://localhost:8082/actuator/health

      - name: ğŸ§ª Executar testes automÃ¡ticos Maven
        run: |
          echo "ğŸ¯ Executando testes no conta-service"
          cd conta-service && mvn test -q
          cd ../kafka-service && echo "ğŸ¯ Executando testes no kafka-service" && mvn test -q

      - name: ğŸ§¹ Limpeza final
        if: always()
        run: |
          docker compose -f infra/docker-compose.yml down -v --remove-orphans
          docker system prune -af
