name: CI/CD MicroserviÃ§os

on:
  push:
    branches: [ main ]

env:
  # VariÃ¡veis de ambiente para configuraÃ§Ã£o
  JAVA_VERSION: '21'
  MAVEN_OPTS: '--add-opens java.base/java.lang=ALL-UNNAMED'

jobs:
  # Job de Build e Testes dos MicroserviÃ§os
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [conta-service, kafka-service]

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "[2] Configurar JDK ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: "[3] Build e Testes do ${{ matrix.service }}"
        run: |
          echo "ðŸ—ï¸  Building ${{ matrix.service }}..."
          cd ${{ matrix.service }}
          mvn clean compile test -DskipTests=false
          echo "âœ… ${{ matrix.service }} build e testes concluÃ­dos"

  # Job de IntegraÃ§Ã£o Docker - CORREÃ‡ÃƒO APLICADA AQUI
  docker-integration:
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 15

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "[2] Configurar JDK ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: "[3] Build do Projeto Raiz para DependÃªncias"
        run: |
          echo "ðŸ“¦ Instalando dependÃªncias do projeto raiz..."
          mvn clean install -DskipTests -Dcheckstyle.skip=true -Dspotbugs.skip=true
          echo "âœ… DependÃªncias instaladas"

      - name: "[4] Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:buildx-stable-1

      - name: "[5] Build das Imagens Docker Individualmente"
        run: |
          echo "ðŸ³ Build das imagens Docker..."
          
          echo "ðŸ”¨ Build da imagem Conta Service..."
          docker build \
            --progress=plain \
            --no-cache \
            -t conta-service:latest \
            -f conta-service/Dockerfile \
            .
          
          echo "ðŸ”¨ Build da imagem Kafka Service..."
          docker build \
            --progress=plain \
            --no-cache \
            -t kafka-service:latest \
            -f kafka-service/Dockerfile \
            .
          
          echo "âœ… Build das imagens concluÃ­do"

      - name: "[6] Verificar Imagens ConstruÃ­das"
        run: |
          echo "ðŸ“Š Imagens Docker disponÃ­veis:"
          docker images
          
          echo "ðŸ” Detalhes das imagens:"
          docker image inspect conta-service:latest --format '{{ .RepoTags }}: {{ .Size }}'
          docker image inspect kafka-service:latest --format '{{ .RepoTags }}: {{ .Size }}'

      - name: "[7] Iniciar Infraestrutura com Docker Compose"
        run: |
          echo "ðŸš€ Iniciando infraestrutura com Docker Compose..."
          cd infra
          
          # Build dos serviÃ§os com Docker Compose (usando cache das imagens)
          docker compose build --no-cache --progress=plain
          
          # Subir serviÃ§os em background
          docker compose up -d
          
          echo "â³ Aguardando inicializaÃ§Ã£o dos serviÃ§os..."
          sleep 30

      - name: "[8] Verificar Status dos ServiÃ§os"
        run: |
          echo "ðŸ“Š Status dos containers:"
          cd infra
          docker compose ps
          
          echo "ðŸ” Logs dos serviÃ§os Spring Boot:"
          docker compose logs conta-service --tail=50
          docker compose logs kafka-service --tail=50
          
          echo "ðŸ”§ Logs da infraestrutura:"
          docker compose logs postgres --tail=20
          docker compose logs kafka-broker --tail=20
          docker compose logs zookeeper --tail=20

      - name: "[9] Testar Health Checks dos ServiÃ§os"
        run: |
          echo "ðŸ¥ Testando health checks..."
          cd infra
          
          # Aguardar mais tempo para serviÃ§os Spring Boot inicializarem
          echo "â³ Aguardando inicializaÃ§Ã£o completa..."
          sleep 30
          
          # Testar Conta Service com retry
          echo "ðŸ” Testando Conta Service..."
          for i in {1..5}; do
            if curl -s -f http://localhost:8081/actuator/health > /dev/null 2>&1; then
              echo "âœ… Conta Service estÃ¡ saudÃ¡vel"
              break
            else
              echo "â³ Tentativa $i: Conta Service ainda nÃ£o estÃ¡ pronto..."
              sleep 10
            fi
          done
          
          # Testar Kafka Service com retry
          echo "ðŸ” Testando Kafka Service..."
          for i in {1..5}; do
            if curl -s -f http://localhost:8082/actuator/health > /dev/null 2>&1; then
              echo "âœ… Kafka Service estÃ¡ saudÃ¡vel"
              break
            else
              echo "â³ Tentativa $i: Kafka Service ainda nÃ£o estÃ¡ pronto..."
              sleep 10
            fi
          done
          
          # Teste final
          echo "ðŸŽ¯ Teste final de conectividade..."
          curl -f http://localhost:8081/actuator/health && echo "âœ… Conta Service: OK" || echo "âŒ Conta Service: FALHOU"
          curl -f http://localhost:8082/actuator/health && echo "âœ… Kafka Service: OK" || echo "âŒ Kafka Service: FALHOU"

      - name: "[10] Coletar Logs em Caso de Falha"
        if: failure()
        run: |
          echo "ðŸ“ Coletando logs para debugging..."
          cd infra
          docker compose logs --tail=100 > docker-compose-logs.txt
          echo "ðŸ“„ Logs salvos em docker-compose-logs.txt"
          
          # Logs detalhados de cada serviÃ§o
          docker compose logs conta-service > conta-service-logs.txt
          docker compose logs kafka-service > kafka-service-logs.txt
          
          # Exibir Ãºltimos logs
          echo "=== Ãšltimos logs do Conta Service ==="
          tail -50 conta-service-logs.txt
          echo "=== Ãšltimos logs do Kafka Service ==="
          tail -50 kafka-service-logs.txt

      - name: "[11] Limpar Ambiente"
        if: always()
        run: |
          echo "ðŸ§¹ Limpando ambiente..."
          cd infra
          docker compose down -v --remove-orphans
          echo "âœ… Ambiente limpo"

  # Job de Security Scan
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "[2] Security Scan com OWASP Dependency Check"
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'api-funcoes-teste-spring'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --scan conta-service/
            --scan kafka-service/
            --enableRetired

      - name: "[3] Upload Security Report"
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            dependency-check-report.html
            dependency-check-report.xml