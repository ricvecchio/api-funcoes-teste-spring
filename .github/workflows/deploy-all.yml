name: 🚀 CI/CD - Build e Deploy Completo

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
      IMAGE_CACHE_DIR: /tmp/.buildx-cache
      CONTA_SERVICE_PATH: ./conta-service
      KAFKA_SERVICE_PATH: ./kafka-service
      INFRA_PATH: ./infra

    steps:
      # -------------------------------------------
      # 🧩 Checkout do código
      # -------------------------------------------
      - name: 📦 Checkout do código
        uses: actions/checkout@v4

      # -------------------------------------------
      # ☕ Setup do Java 21
      # -------------------------------------------
      - name: ☕ Configurando Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # -------------------------------------------
      # 🏗️ Build do conta-service (único que gera JAR)
      # -------------------------------------------
      - name: 🏗️ Buildando conta-service (Maven)
        working-directory: ./conta-service
        run: |
          echo "🏗️ Buildando conta-service..."
          mvn clean package -DskipTests
          echo "✅ Build concluído para conta-service"

      # -------------------------------------------
      # 🧰 Setup do Docker Buildx
      # -------------------------------------------
      - name: 🔧 Configurando Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------------------
      # 💾 Restaurar cache de build
      # -------------------------------------------
      - name: 💾 Restaurando cache de build
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # -------------------------------------------
      # 🐳 Build das imagens Docker com cache
      # -------------------------------------------
      - name: 🐳 Buildando imagens Docker com cache
        run: |
          echo "🐳 Buildando imagens Docker com cache..."
          docker compose --env-file ./infra/.env -f ./infra/docker-compose.yml build
          echo "✅ Build de imagens Docker concluído"

      # -------------------------------------------
      # 🚀 Subindo containers
      # -------------------------------------------
      - name: 🚀 Subindo containers
        run: |
          echo "🚀 Subindo containers..."
          docker compose --env-file ./infra/.env -f ./infra/docker-compose.yml up -d
          echo "✅ Containers subidos com sucesso"

      # -------------------------------------------
      # 🔍 Logs detalhados
      # -------------------------------------------
      - name: 🔍 Logs detalhados dos serviços
        run: |
          echo "🔍 Containers ativos:"
          docker ps -a
          echo "=== conta-service logs ==="
          docker logs conta-service || true
          echo "=== kafka-service logs ==="
          docker logs kafka-service || true
          echo "=== postgres-db logs ==="
          docker logs postgres-db || true
          echo "=== kafka-broker logs ==="
          docker logs kafka-broker || true
          echo "=== zookeeper logs ==="
          docker logs zookeeper || true

      # -------------------------------------------
      # 🧹 Limpeza final
      # -------------------------------------------
      - name: 🧹 Limpando containers e cache
        if: always()
        run: |
          echo "🧹 Removendo containers..."
          docker compose -f ./infra/docker-compose.yml down -v || true
          echo "🧹 Limpando cache temporário..."
          rm -rf /tmp/.buildx-cache || true
          echo "✅ Limpeza concluída"
