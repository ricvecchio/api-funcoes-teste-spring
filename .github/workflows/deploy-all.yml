name: Deploy All Services

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  ci-deploy:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.8-9/x64
      JAVA_HOME_21_X64: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/21.0.8-9/x64
      POSTGRES_PORT: 5432
      ZOOKEEPER_PORT: 2181
      KAFKA_BROKER_PORT: 9092
      CONTA_SERVICE_PORT: 8081
      KAFKA_SERVICE_PORT: 8082

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: ğŸš€ Start CI infrastructure Postgres + Zookeeper
        run: |
          set -euo pipefail
          echo "ğŸš€ Iniciando infra CI: postgres + zookeeper..."
          docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml up -d postgres zookeeper

          echo "â³ Aguardando Zookeeper (atÃ© 120s)..."
          max_attempts=24
          attempt=1
          until docker exec zookeeper bash -c "echo ruok | nc -w 1 127.0.0.1 2181 | grep imok" >/dev/null 2>&1; do
            if [ $attempt -ge $max_attempts ]; then
              echo "âŒ Zookeeper nÃ£o ficou pronto apÃ³s $((max_attempts*5))s"
              docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml logs zookeeper --tail=200
              docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml down -v --remove-orphans
              exit 1
            fi
            echo "â³ Zookeeper nÃ£o estÃ¡ pronto... tentativa $attempt/$max_attempts"
            attempt=$((attempt+1))
            sleep 5
          done
          echo "âœ… Zookeeper pronto!"

      - name: ğŸš€ Start Kafka Broker
        run: |
          echo "ğŸš€ Subindo Kafka broker..."
          docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml up -d kafka-broker

          echo "â³ Aguardando Kafka Broker (atÃ© 90s)..."
          max_attempts=18
          attempt=1
          until docker exec kafka-broker bash -c "kafka-broker-api-versions --bootstrap-server localhost:9092 >/dev/null 2>&1"; do
            if [ $attempt -ge $max_attempts ]; then
              echo "âŒ Kafka Broker nÃ£o pronto apÃ³s $((max_attempts*5))s"
              docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml logs kafka-broker --tail=200
              docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml down -v --remove-orphans
              exit 1
            fi
            echo "â³ Kafka Broker nÃ£o estÃ¡ pronto... tentativa $attempt/$max_attempts"
            attempt=$((attempt+1))
            sleep 5
          done
          echo "âœ… Kafka Broker pronto!"

      - name: ğŸš€ Start application services
        run: |
          echo "ğŸš€ Subindo serviÃ§os de aplicaÃ§Ã£o..."
          docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml up -d conta-service kafka-service

          echo "â³ Healthchecks dos serviÃ§os (atÃ© 2 min)..."
          for svc in conta-service kafka-service; do
            max_try=24
            try=1
            port=8081
            if [ "$svc" = "kafka-service" ]; then port=8082; fi
            while ! curl -s -f "http://localhost:${port}/actuator/health" >/dev/null 2>&1; do
              if [ $try -ge $max_try ]; then
                echo "âŒ $svc healthcheck failed"
                docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml logs $svc --tail=200
                docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml down -v --remove-orphans
                exit 1
              fi
              echo "â³ $svc nÃ£o estÃ¡ pronto... tentativa $try/$max_try"
              try=$((try+1))
              sleep 5
            done
            echo "âœ… $svc ok"
          done

      - name: ğŸ‰ Cleanup
        run: |
          echo "ğŸ‰ IntegraÃ§Ã£o OK - limpando ambientes..."
          docker compose -f ./api-funcoes-teste-spring/infra/docker-compose.yml down -v --remove-orphans
