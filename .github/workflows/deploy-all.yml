name: Deploy All Services (CI com cache de imagens Docker)

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      CONTA_SERVICE_PATH: ./conta-service
      KAFKA_SERVICE_PATH: ./kafka-service
      INFRA_PATH: ./infra
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
      IMAGE_CACHE_DIR: /tmp/.buildx-cache

    steps:
      # ======================================
      # 1Ô∏è‚É£ Checkout do reposit√≥rio
      # ======================================
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      # ======================================
      # 2Ô∏è‚É£ Configurar Java (para builds Maven)
      # ======================================
      - name: Configurar Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # ======================================
      # 3Ô∏è‚É£ Restaurar cache de imagens Docker
      # ======================================
      - name: Restaurar cache de imagens Docker
        id: docker-cache
        uses: actions/cache@v4
        with:
          path: ${{ env.IMAGE_CACHE_DIR }}
          key: ${{ runner.os }}-docker-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-

      # ======================================
      # 4Ô∏è‚É£ Build dos microservi√ßos (Spring Boot)
      # ======================================
      - name: Build conta-service
        working-directory: ${{ env.CONTA_SERVICE_PATH }}
        run: |
          echo "üèóÔ∏è  Buildando conta-service..."
          mvn clean package -DskipTests
          echo "‚úÖ Build conclu√≠do para conta-service"

      - name: Build kafka-service
        working-directory: ${{ env.KAFKA_SERVICE_PATH }}
        run: |
          echo "üèóÔ∏è  Buildando kafka-service..."
          mvn clean package -DskipTests
          echo "‚úÖ Build conclu√≠do para kafka-service"

      # ======================================
      # 5Ô∏è‚É£ Configurar Docker Buildx (necess√°rio p/ cache)
      # ======================================
      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ======================================
      # 6Ô∏è‚É£ Verificar vers√µes do Docker
      # ======================================
      - name: Verificar vers√µes
        run: |
          docker version
          docker compose version

      # ======================================
      # 7Ô∏è‚É£ Subir containers com cache de build
      # ======================================
      - name: Subir containers com Docker Compose
        working-directory: ${{ env.INFRA_PATH }}
        run: |
          echo "üöÄ Subindo containers com cache de build..."
          docker compose --env-file .env build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --progress=plain
          docker compose --env-file .env up -d
          echo "‚úÖ Containers iniciados"
          docker ps -a

      # ======================================
      # 8Ô∏è‚É£ Aguardar PostgreSQL e Zookeeper ficarem 'healthy'
      # ======================================
      - name: Aguardar servi√ßos essenciais
        run: |
          echo "‚è≥ Aguardando PostgreSQL e Zookeeper ficarem prontos..."
          for i in {1..30}; do
            STATUS_DB=$(docker inspect --format='{{.State.Health.Status}}' postgres-db 2>/dev/null || echo "none")
            STATUS_ZK=$(docker inspect --format='{{.State.Health.Status}}' zookeeper 2>/dev/null || echo "none")
            echo "Tentativa $i ‚Üí postgres-db=$STATUS_DB, zookeeper=$STATUS_ZK"
            if [[ "$STATUS_DB" == "healthy" && "$STATUS_ZK" == "healthy" ]]; then
              echo "‚úÖ Ambos os servi√ßos est√£o saud√°veis!"
              break
            fi
            sleep 5
          done

      # ======================================
      # 9Ô∏è‚É£ Exibir logs detalhados dos servi√ßos
      # ======================================
      - name: Exibir logs detalhados
        run: |
          echo "üîç Logs detalhados dos servi√ßos:"
          docker ps -a
          echo "=== conta-service logs ==="
          docker logs conta-service || echo "‚ö†Ô∏è conta-service n√£o encontrado"
          echo "=== kafka-service logs ==="
          docker logs kafka-service || echo "‚ö†Ô∏è kafka-service n√£o encontrado"
          echo "=== postgres-db logs ==="
          docker logs postgres-db || echo "‚ö†Ô∏è postgres-db n√£o encontrado"
          echo "=== kafka-broker logs ==="
          docker logs kafka-broker || echo "‚ö†Ô∏è kafka-broker n√£o encontrado"
          echo "=== zookeeper logs ==="
          docker logs zookeeper || echo "‚ö†Ô∏è zookeeper n√£o encontrado"

      # ======================================
      # üîü Salvar cache de imagens ap√≥s build
      # ======================================
      - name: Salvar cache de imagens Docker
        if: always()
        uses: actions/cache@v4
        with:
          path: ${{ env.IMAGE_CACHE_DIR }}
          key: ${{ runner.os }}-docker-${{ github.sha }}

      # ======================================
      # 1Ô∏è‚É£1Ô∏è‚É£ Encerrar containers ap√≥s execu√ß√£o
      # ======================================
      - name: Encerrar containers
        if: always()
        working-directory: ${{ env.INFRA_PATH }}
        run: |
          echo "üßπ Encerrando containers e limpando volumes..."
          docker compose down -v
          echo "‚úÖ Limpeza conclu√≠da."
