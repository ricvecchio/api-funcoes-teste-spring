name: CI/CD MicroserviÃ§os

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  # Job de Build e Testes
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [conta-service, kafka-service]

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "[2] Configurar JDK 21"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: "[3] Build Projeto Raiz"
        run: |
          echo "ðŸ—ï¸  Building projeto raiz..."
          mvn clean install -DskipTests

      - name: "[4] Build ${{ matrix.service }}"
        run: |
          echo "ðŸ”§ Building ${{ matrix.service }}..."
          cd ${{ matrix.service }}
          mvn clean compile -DskipTests

      - name: "[5] Testes ${{ matrix.service }}"
        run: |
          echo "ðŸ§ª Executando testes ${{ matrix.service }}..."
          cd ${{ matrix.service }}
          mvn test

      - name: "[6] Package ${{ matrix.service }}"
        run: |
          echo "ðŸ“¦ Packaging ${{ matrix.service }}..."
          cd ${{ matrix.service }}
          mvn package -DskipTests

  # Job de IntegraÃ§Ã£o com Docker
  docker-integration:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "[2] Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "[3] Build Projeto Raiz para Docker"
        run: |
          echo "ðŸ—ï¸  Building projeto raiz para Docker..."
          mvn clean install -DskipTests

      - name: "[4] Build e Testar com Docker Compose"
        run: |
          echo "ðŸ³ Executando Docker Compose..."
          cd infra
          
          # Build das imagens
          docker compose build --no-cache --progress=plain
          
          # Subir serviÃ§os
          docker compose up -d
          
          echo "â³ Aguardando inicializaÃ§Ã£o dos serviÃ§os..."
          sleep 60
          
          # Verificar status
          echo "ðŸ“Š Status dos containers:"
          docker compose ps
          
          # Health checks
          echo "ðŸ¥ Verificando saÃºde dos serviÃ§os..."
          docker compose logs --tail=50
          
          # Testar serviÃ§os
          echo "ðŸ§ª Testando conectividade..."
          curl -f http://localhost:8081/actuator/health || (echo "âŒ Conta Service falhou" && exit 1)
          curl -f http://localhost:8082/actuator/health || (echo "âŒ Kafka Service falhou" && exit 1)
          
          echo "âœ… Todos os serviÃ§os estÃ£o respondendo!"

      - name: "[5] Parar serviÃ§os"
        if: always()
        run: |
          cd infra
          docker compose down
          echo "ðŸ§¹ ServiÃ§os parados"

  # Job de Security Scan (Opcional)
  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "[2] Dependency Check"
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'api-funcoes-teste-spring'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --scan conta-service/
            --scan kafka-service/
            --enableRetired

      - name: "[3] Upload Report"
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: reports/