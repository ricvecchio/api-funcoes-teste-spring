name: CI Integra√ß√£o Microservi√ßos

on:
  push:
    branches:
      - main

jobs:
  build_all:
    runs-on: ubuntu-latest

    steps:
      - name: "[1] Checkout do c√≥digo"
        uses: actions/checkout@v4

      - name: "[2] Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "[3] Configurar JDK 21"
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: "[4] Configurar Maven"
        run: |
          sudo apt-get update
          sudo apt-get install -y maven

      # Build Conta Service
      - name: "[5] Build Conta Service"
        run: |
          echo "üèóÔ∏è  Building Conta Service..."
          cd conta-service
          mvn clean compile -DskipTests

      # Build Kafka Service
      - name: "[6] Build Kafka Service"
        run: |
          echo "üèóÔ∏è  Building Kafka Service..."
          cd kafka-service
          mvn clean compile -DskipTests

      # CORRE√á√ÉO: Adicionar passo para verificar Dockerfiles
      - name: "[7] Verificar Dockerfiles"
        run: |
          echo "üîç Verificando Dockerfiles..."
          echo "=== Conta Service Dockerfile ==="
          cat conta-service/Dockerfile
          echo "=== Kafka Service Dockerfile ==="
          cat kafka-service/Dockerfile

      # CORRE√á√ÉO: Usar build com cache para melhor performance
      - name: "[8] Docker Compose Up com Build"
        run: |
          echo "üê≥ Executando Docker Compose..."
          
          if [ -d "infra" ] && [ -f "infra/docker-compose.yml" ]; then
            echo "‚úÖ Usando infra/docker-compose.yml"
            cd infra
          
            echo "üöÄ Iniciando servi√ßos com Docker Compose..."
            docker compose version
          
            # Build com cache para melhor performance
            docker compose build --no-cache
          
            # Subir servi√ßos
            docker compose up -d
          
            echo "üìä Status dos containers:"
            docker compose ps
          
          else
            echo "‚ùå infra/docker-compose.yml n√£o encontrado"
            exit 1
          fi

      - name: "[9] Verificar sa√∫de dos servi√ßos"
        run: |
          echo "üè• Verificando sa√∫de dos servi√ßos..."
          cd infra
          sleep 30
          
          echo "üìä Containers em execu√ß√£o:"
          docker compose ps
          
          echo "üîç Verificando logs:"
          docker compose logs --tail=20
          
          # Testar conectividade com timeout
          echo "üåê Testando conectividade..."
          timeout 15s bash -c 'until curl -s -f http://localhost:8081/actuator/health; do echo "Aguardando Conta Service..."; sleep 3; done' || echo "Conta Service n√£o responde"
          timeout 15s bash -c 'until curl -s -f http://localhost:8082/actuator/health; do echo "Aguardando Kafka Service..."; sleep 3; done' || echo "Kafka Service n√£o responde"

      - name: "[10] Parar servi√ßos"
        if: always()
        run: |
          cd infra
          docker compose down
          echo "üßπ Servi√ßos parados"