name: ğŸš€ CI/CD - Build e Deploy Completo

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
      IMAGE_CACHE_DIR: /tmp/.buildx-cache
      CONTA_SERVICE_PATH: ./conta-service
      KAFKA_SERVICE_PATH: ./kafka-service
      INFRA_PATH: ./infra

    steps:
      # -------------------------------------------
      # ğŸ§© Checkout do cÃ³digo
      # -------------------------------------------
      - name: ğŸ“¦ Checkout do cÃ³digo
        uses: actions/checkout@v4

      # -------------------------------------------
      # â˜• Setup do Java 21
      # -------------------------------------------
      - name: â˜• Configurando Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # -------------------------------------------
      # ğŸ—ï¸ Build do conta-service (Ãºnico que gera JAR)
      # -------------------------------------------
      - name: ğŸ—ï¸ Buildando conta-service (Maven)
        working-directory: ./conta-service
        run: |
          echo "ğŸ—ï¸ Buildando conta-service..."
          mvn clean package -DskipTests
          echo "âœ… Build concluÃ­do para conta-service"

      # -------------------------------------------
      # ğŸ§° Setup do Docker Buildx
      # -------------------------------------------
      - name: ğŸ”§ Configurando Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -------------------------------------------
      # ğŸ’¾ Restaurar cache de build
      # -------------------------------------------
      - name: ğŸ’¾ Restaurando cache de build
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # -------------------------------------------
      # ğŸ³ Build das imagens Docker com cache
      # -------------------------------------------
      - name: ğŸ³ Buildando imagens Docker com cache
        run: |
          echo "ğŸ³ Buildando imagens Docker com cache..."
          docker compose --env-file ./infra/.env -f ./infra/docker-compose.yml build
          echo "âœ… Build de imagens Docker concluÃ­do"

      # -------------------------------------------
      # ğŸš€ Subindo containers
      # -------------------------------------------
      - name: ğŸš€ Subindo containers
        run: |
          echo "ğŸš€ Subindo containers..."
          docker compose --env-file ./infra/.env -f ./infra/docker-compose.yml up -d
          echo "âœ… Containers subidos com sucesso"

      # -------------------------------------------
      # ğŸ” Logs detalhados
      # -------------------------------------------
      - name: ğŸ” Logs detalhados dos serviÃ§os
        run: |
          echo "ğŸ” Containers ativos:"
          docker ps -a
          echo "=== conta-service logs ==="
          docker logs conta-service || true
          echo "=== kafka-service logs ==="
          docker logs kafka-service || true
          echo "=== postgres-db logs ==="
          docker logs postgres-db || true
          echo "=== kafka-broker logs ==="
          docker logs kafka-broker || true
          echo "=== zookeeper logs ==="
          docker logs zookeeper || true

      # -------------------------------------------
      # ğŸ§¹ Limpeza final
      # -------------------------------------------
      - name: ğŸ§¹ Limpando containers e cache
        if: always()
        run: |
          echo "ğŸ§¹ Removendo containers..."
          docker compose -f ./infra/docker-compose.yml down -v || true
          echo "ğŸ§¹ Limpando cache temporÃ¡rio..."
          rm -rf /tmp/.buildx-cache || true
          echo "âœ… Limpeza concluÃ­da"
