name: CI/CD MicroserviÃ§os

on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [conta-service, kafka-service]

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "[2] Configurar JDK 21"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: "[3] Build Projeto Raiz"
        run: |
          echo "ðŸ—ï¸  Building projeto raiz..."
          mvn clean install -DskipTests -q

      - name: "[4] Build e Testes ${{ matrix.service }}"
        run: |
          echo "ðŸ”§ Building ${{ matrix.service }}..."
          cd ${{ matrix.service }}
          mvn clean compile test -q

  docker-integration:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "[2] Configurar Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "[3] Build das Imagens Docker"
        run: |
          echo "ðŸ³ Build das imagens Docker..."
          docker build -t conta-service:latest -f conta-service/Dockerfile .
          docker build -t kafka-service:latest -f kafka-service/Dockerfile .

      - name: "[4] Iniciar Infraestrutura BÃ¡sica"
        run: |
          echo "ðŸš€ Iniciando PostgreSQL e Kafka..."
          cd infra
          
          # Iniciar apenas infraestrutura bÃ¡sica
          docker compose up -d postgres zookeeper kafka-broker
          
          echo "â³ Aguardando infraestrutura..."
          sleep 30

      - name: "[5] Verificar Infraestrutura"
        run: |
          echo "ðŸ” Verificando infraestrutura..."
          cd infra
          docker compose ps
          
          # Verificar se serviÃ§os de infra estÃ£o rodando
          if docker compose ps postgres | grep -q "Up"; then
            echo "âœ… PostgreSQL estÃ¡ rodando"
          else
            echo "âŒ PostgreSQL nÃ£o estÃ¡ rodando"
            docker compose logs postgres
            exit 1
          fi
          
          if docker compose ps kafka-broker | grep -q "Up"; then
            echo "âœ… Kafka estÃ¡ rodando"
          else
            echo "âŒ Kafka nÃ£o estÃ¡ rodando"
            docker compose logs kafka-broker
            docker compose logs zookeeper
            exit 1
          fi

      - name: "[6] Iniciar e Testar Conta Service"
        run: |
          echo "ðŸš€ Iniciando Conta Service..."
          cd infra
          
          # Iniciar apenas conta-service primeiro
          docker compose up -d conta-service
          
          echo "â³ Aguardando Conta Service iniciar..."
          sleep 30
          
          # Verificar se o serviÃ§o estÃ¡ rodando
          if docker compose ps conta-service | grep -q "Up"; then
            echo "âœ… Conta Service estÃ¡ rodando"
          else
            echo "âŒ Conta Service nÃ£o estÃ¡ rodando"
            docker compose logs conta-service
            exit 1
          fi
          
          # Testar health check
          echo "ðŸ¥ Testando Conta Service..."
          if curl -s -f http://localhost:8081/actuator/health; then
            echo "âœ…âœ… CONTA SERVICE: HEALTH CHECK PASSOU"
          else
            echo "âŒâŒ CONTA SERVICE: HEALTH CHECK FALHOU"
            docker compose logs conta-service --tail=50
            exit 1
          fi

      - name: "[7] Iniciar e Testar Kafka Service"
        run: |
          echo "ðŸš€ Iniciando Kafka Service..."
          cd infra
          
          # Iniciar kafka-service
          docker compose up -d kafka-service
          
          echo "â³ Aguardando Kafka Service iniciar..."
          sleep 30
          
          # Verificar se o serviÃ§o estÃ¡ rodando
          if docker compose ps kafka-service | grep -q "Up"; then
            echo "âœ… Kafka Service estÃ¡ rodando"
          else
            echo "âŒ Kafka Service nÃ£o estÃ¡ rodando"
            docker compose logs kafka-service
            exit 1
          fi
          
          # Testar health check com mÃºltiplas tentativas
          echo "ðŸ¥ Testando Kafka Service..."
          for i in {1..5}; do
            if curl -s -f http://localhost:8082/actuator/health; then
              echo "âœ…âœ… KAFKA SERVICE: HEALTH CHECK PASSOU"
              break
            else
              echo "â³ Tentativa $i: Kafka Service nÃ£o responde, aguardando..."
              sleep 10
            fi
          done
          
          # Teste final
          if curl -s -f http://localhost:8082/actuator/health; then
            echo "ðŸŽ‰ KAFKA SERVICE: SAUDÃVEL"
          else
            echo "ðŸ’¥ KAFKA SERVICE: HEALTH CHECK FALHOU"
            docker compose logs kafka-service --tail=50
            exit 1
          fi

      - name: "[8] Teste Final de IntegraÃ§Ã£o"
        run: |
          echo "ðŸŽ¯ Teste final de integraÃ§Ã£o..."
          cd infra
          
          echo "ðŸ“Š Status final:"
          docker compose ps
          
          echo "âœ…âœ… INTEGRAÃ‡ÃƒO DOCKER: SUCESSO!"

      - name: "[9] Limpar Ambiente"
        if: always()
        run: |
          cd infra
          docker compose down -v
          echo "ðŸ§¹ Ambiente limpo"

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: "[1] Checkout"
        uses: actions/checkout@v4

      - name: "[2] Security Scan"
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'api-funcoes-teste-spring'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --scan conta-service/
            --scan kafka-service/

      - name: "[3] Upload Report"
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/