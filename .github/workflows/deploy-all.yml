name: CI/CD MicroserviÃ§os

on:
  push:
    branches: [ main ]

env:
  JAVA_VERSION: '21'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [conta-service, kafka-service]

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "[2] Configurar JDK ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: "[3] Build Projeto Raiz"
        run: |
          echo "ðŸ—ï¸  Building projeto raiz..."
          mvn clean install -DskipTests -q
          echo "âœ… Build projeto raiz concluÃ­do"

      - name: "[4] Build e Testes ${{ matrix.service }}"
        run: |
          echo "ðŸ”§ Building ${{ matrix.service }}..."
          cd ${{ matrix.service }}
          mvn clean compile test -q
          echo "âœ… ${{ matrix.service }} build e testes concluÃ­dos"

  docker-integration:
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 25

    steps:
      - name: "[1] Checkout do cÃ³digo"
        uses: actions/checkout@v4

      - name: "[2] Configurar Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "[3] Build das Imagens Docker"
        run: |
          echo "ðŸ³ Build das imagens Docker..."
          
          echo "ðŸ”¨ Build Conta Service..."
          docker build \
            -t conta-service:latest \
            -f conta-service/Dockerfile \
            .
          
          echo "ðŸ”¨ Build Kafka Service..."
          docker build \
            -t kafka-service:latest \
            -f kafka-service/Dockerfile \
            .
          
          echo "âœ… Build das imagens concluÃ­do"

      - name: "[4] Iniciar Infraestrutura"
        run: |
          echo "ðŸš€ Iniciando infraestrutura..."
          cd infra
          
          # Limpar ambiente anterior
          docker compose down -v --remove-orphans
          
          # Iniciar apenas infraestrutura primeiro
          docker compose up -d postgres zookeeper kafka-broker
          
          echo "â³ Aguardando infraestrutura ficar pronta..."
          sleep 60

      - name: "[5] Verificar Infraestrutura"
        run: |
          echo "ðŸ” Verificando infraestrutura..."
          cd infra
          
          echo "ðŸ“Š Status dos containers de infra:"
          docker compose ps
          
          # Verificar se todos os serviÃ§os de infra estÃ£o saudÃ¡veis
          echo "ðŸ¥ Verificando saÃºde da infraestrutura..."
          docker compose logs postgres --tail=5
          docker compose logs zookeeper --tail=5
          docker compose logs kafka-broker --tail=10

      - name: "[6] Iniciar MicroserviÃ§os"
        run: |
          echo "ðŸš€ Iniciando microserviÃ§os..."
          cd infra
          
          # Iniciar microserviÃ§os apÃ³s infra estar pronta
          docker compose up -d conta-service kafka-service
          
          echo "â³ Aguardando microserviÃ§os iniciarem..."
          sleep 90

      - name: "[7] Verificar Logs dos MicroserviÃ§os"
        run: |
          echo "ðŸ“ Verificando logs dos microserviÃ§os..."
          cd infra
          
          echo "=== LOGS CONTA SERVICE ==="
          docker compose logs conta-service --tail=50
          
          echo "=== LOGS KAFKA SERVICE ==="
          docker compose logs kafka-service --tail=50
          
          echo "ðŸ“Š Status final dos containers:"
          docker compose ps

      - name: "[8] Testar Health Checks com Abordagem Robusta"
        run: |
          echo "ðŸ¥ Testando health checks com abordagem robusta..."
          cd infra
          
          # FunÃ§Ã£o para testar health check com retry
          test_health_check() {
            local service_name=$1
            local port=$2
            local max_attempts=15
            local attempt=1
          
            echo "ðŸ” Testando $service_name na porta $port..."
          
            while [ $attempt -le $max_attempts ]; do
              if curl -s -f "http://localhost:$port/actuator/health" > /dev/null 2>&1; then
                echo "âœ…âœ… $service_name: HEALTHY (tentativa $attempt)"
                return 0
              else
                echo "â³ $service_name: Aguardando... tentativa $attempt/$max_attempts"
                sleep 10
                attempt=$((attempt + 1))
              fi
            done
          
            echo "âŒâŒ $service_name: HEALTH CHECK FALHOU apÃ³s $max_attempts tentativas"
            return 1
          }
          
          # Testar serviÃ§os
          if test_health_check "Conta Service" "8081"; then
            echo "ðŸŽ¯ CONTA SERVICE: TESTE DE SAÃšDE PASSOU"
          else
            echo "ðŸ’¥ CONTA SERVICE: TESTE DE SAÃšDE FALHOU"
            # Coletar logs detalhados antes de falhar
            docker compose logs conta-service --tail=100
            exit 1
          fi
          
          if test_health_check "Kafka Service" "8082"; then
            echo "ðŸŽ¯ KAFKA SERVICE: TESTE DE SAÃšDE PASSOU"
          else
            echo "ðŸ’¥ KAFKA SERVICE: TESTE DE SAÃšDE FALHOU"
            # Coletar logs detalhados antes de falhar
            docker compose logs kafka-service --tail=100
            exit 1
          fi
          
          echo "ðŸŽ‰ðŸŽ‰ TODOS OS SERVIÃ‡OS ESTÃƒO SAUDÃVEIS!"

      - name: "[9] Testes Adicionais de Funcionalidade"
        if: success()
        run: |
          echo "ðŸ§ª Executando testes adicionais de funcionalidade..."
          cd infra
          
          # Testar endpoints especÃ­ficos
          echo "ðŸ” Testando endpoints de info..."
          curl -s http://localhost:8081/actuator/info | jq '.' || echo "Info endpoint nÃ£o disponÃ­vel"
          curl -s http://localhost:8082/actuator/info | jq '.' || echo "Info endpoint nÃ£o disponÃ­vel"
          
          echo "âœ… Testes adicionais concluÃ­dos"

      - name: "[10] Coletar Logs em Caso de Falha"
        if: failure()
        run: |
          echo "ðŸ“ Coletando logs detalhados para anÃ¡lise..."
          cd infra
          
          # Salvar todos os logs
          docker compose logs > docker-compose-full-logs.txt
          docker compose logs conta-service > conta-service-full-logs.txt
          docker compose logs kafka-service > kafka-service-full-logs.txt
          docker compose logs kafka-broker > kafka-broker-full-logs.txt
          docker compose logs postgres > postgres-full-logs.txt
          
          # Exibir resumo dos logs
          echo "=== RESUMO DOS LOGS ==="
          echo "CONTA SERVICE (Ãºltimas 50 linhas):"
          tail -50 conta-service-full-logs.txt
          echo ""
          echo "KAFKA SERVICE (Ãºltimas 50 linhas):"
          tail -50 kafka-service-full-logs.txt
          echo ""
          echo "KAFKA BROKER (Ãºltimas 30 linhas):"
          tail -30 kafka-broker-full-logs.txt

      - name: "[11] Limpar Ambiente"
        if: always()
        run: |
          cd infra
          docker compose down -v --remove-orphans
          echo "ðŸ§¹ Ambiente limpo"

  security-scan:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: "[1] Checkout"
        uses: actions/checkout@v4

      - name: "[2] Security Scan"
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'api-funcoes-teste-spring'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --scan conta-service/
            --scan kafka-service/

      - name: "[3] Upload Report"
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/